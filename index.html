<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>master.gabriels.dungeon</title>
<meta name="theme-color" content="#0a0006"/>
<meta name="robots" content="noindex, nofollow"/>
<link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg'><text y='32' font-size='32'>üóùÔ∏è</text></svg>">
<style>
:root{ --accent:#ff1e8a; --accent-soft:#ff99cc; --ink:#ffd6ea; --ink-soft:#e6cfe0; --panel:rgba(10,10,10,.72); --stroke:#aa0066; --bg:#000 }
*{ box-sizing:border-box }
html,body{ height:100%; margin:0 }
body{ font-family: Georgia, serif; background:var(--bg); color:#fff; overflow:auto }
:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; border-radius: 6px }
.sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0 }

/* Overlays */
[role="dialog"]{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.92); z-index:1000 }
.dialog-card{ background:var(--panel); border:1px solid var(--stroke); border-radius:16px; padding:28px 24px; width:min(92vw,560px); text-align:center; box-shadow:0 0 24px rgba(170,0,102,.6) }
.title{ font-size:1.6rem; margin:0 0 10px; color:var(--accent-soft); text-shadow:0 0 8px var(--accent) }
.sub{ font-size:.95rem; color:var(--ink-soft); margin-bottom:16px }
.input{ width:100%; padding:12px 14px; font-size:1rem; border-radius:10px; border:1px solid var(--accent); background:#0a0a0a; color:#fff; outline:none; transition: box-shadow .25s, border-color .25s; box-shadow:0 0 10px rgba(255,30,138,.2) }
.input:focus{ border-color: var(--accent-soft); box-shadow:0 0 16px rgba(255,30,138,.45) }
.btn{ display:inline-flex; align-items:center; gap:8px; margin-top:12px; padding:10px 16px; border-radius:10px; border:1px solid var(--accent); background:#13030a; color:#ffb3d9; cursor:pointer; transition: transform .15s, background .3s }
.btn:hover{ transform: translateY(-1px); background:#1b0a14 }
.btn.secondary{ border-color: rgba(255,255,255,.25); color:#fff }
.row{ display:flex; gap:10px; justify-content:center; align-items:center }
.hr{ height:1px; background:linear-gradient(90deg,transparent,var(--accent),transparent); margin:16px 0 }
label{ display:block; margin:10px 0 6px }
small{ color:var(--ink-soft); opacity:.85 }

#trace-canvas{ background: radial-gradient(ellipse at center, rgba(255,20,147,.08), rgba(0,0,0,.2) 70%); border:1px dashed #ff66a3; border-radius:12px; display:block }

/* App */
#topbar{ position:fixed; top:0; left:0; right:0; z-index:20; display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:linear-gradient(to bottom, rgba(0,0,0,.6), rgba(0,0,0,0)) }
#nav{ display:flex; gap:10px }
.navbtn{ padding:8px 12px; border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.35); color:#fff; border-radius:10px; cursor:pointer }
.navbtn.active{ border-color: var(--accent); color: var(--accent-soft); text-shadow:0 0 8px var(--accent) }

#app{ position:relative; min-height:100%; width:100% }
#glyph-layer{ position:fixed; inset:0; pointer-events:none; z-index:5 }
.glyph{ position:absolute; font-size:18px; opacity:.16; color:var(--ink); text-shadow:0 0 6px rgba(255,102,163,.35); animation:drift 18s linear infinite }
@keyframes drift{ 0%{ transform:translateY(0) translateX(0) rotate(0deg); opacity:0 } 15%{ opacity:.22 } 85%{ opacity:.22 } 100%{ transform:translateY(-120vh) translateX(8vw) rotate(45deg); opacity:0 } }
.reduce-motion .glyph{ animation:none !important }

#content{ position:relative; z-index:10; width:min(1080px,95vw); margin:10vh auto 6vh; padding:18px; background:rgba(5,5,8,.35); border:1px solid rgba(255,30,138,.25); border-radius:18px; backdrop-filter: blur(6px) }
h1,h2{ text-shadow:0 0 10px rgba(255,30,138,.25) }
.card{ border:1px solid rgba(255,30,138,.28); border-radius:12px; padding:14px; margin:10px 0; background: rgba(10,10,14,.35); cursor:pointer }
.card[data-locked="true"]{ border-style:dashed }
.badge{ display:inline-block; padding:2px 8px; border-radius:12px; background:rgba(255,30,138,.2); color:var(--ink); font-size:.78rem; border:1px solid rgba(255,30,138,.45); margin-right:8px }
.footer{ margin-top:16px; font-size:.85rem; color:var(--ink-soft); opacity:.85 }
.tab{ display:none } .tab.active{ display:block }

.group{ display:flex; gap:8px; align-items:stretch }
.group .input{ flex:1 }
.eye{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); color:#fff; border-radius:10px; padding:10px 12px; cursor:pointer }

/* Gallery */
#gallery-upload{ display:none }
.gallery-controls{ display:flex; gap:10px; margin-bottom:10px; }
#gallery-user, #gallery-builtin, #area-gallery{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px }
.gallery-item{ border:1px solid rgba(255,255,255,.15); border-radius:10px; overflow:hidden; position:relative; background:#0a0a0a }
.gallery-item img{ width:100%; display:block }
.gallery-item .overlay{ position:absolute; top:8px; left:8px; display:flex; gap:8px }
.gallery-item .tag{ font-size:.75rem; padding:4px 8px; border-radius:10px; background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.25) }
.gallery-item.hidden img{ display:none }
.placeholder{
  display:flex; align-items:center; justify-content:center; min-height:140px;
  background: repeating-linear-gradient(45deg, rgba(255,255,255,.04), rgba(255,255,255,.04) 10px, rgba(0,0,0,.25) 10px, rgba(0,0,0,.25) 20px);
  color:#ffd6ea; font-size:28px; letter-spacing:2px; cursor:pointer;
}
.placeholder .showbtn{
  position:absolute; bottom:8px; right:8px; font-size:.8rem; padding:4px 8px; border-radius:10px;
  background:rgba(0,0,0,.65); border:1px solid rgba(255,255,255,.25); cursor:pointer; display:none;
}
.gallery-item.hidden:hover .showbtn{ display:block }

/* Dragging */
.draggable{ cursor:grab }
.draggable:active{ cursor:grabbing }
.drop-target{ outline:2px dashed var(--accent); outline-offset:-6px }

/* Area view */
#area-view{ display:none }
#area-view .back{ margin-bottom:10px }
#area-tabs{ display:flex; gap:10px; margin-bottom:10px }
#area-tabs .navbtn{ padding:6px 10px }
</style>
</head>
<body>
<div id="aria-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<!-- Consent (one-time) -->
<section id="consent" role="dialog" aria-modal="true" aria-labelledby="consent-title">
  <div class="dialog-card" tabindex="-1">
    <h2 id="consent-title" class="title">Consent Bloom</h2>
    <p class="sub">Trace the sigil to offer consent to enter this sacred dungeon.</p>
    <canvas id="trace-canvas" width="420" height="220" aria-label="Trace area"></canvas>
    <div class="hr"></div>
    <div class="row">
      <button id="consent-yes" class="btn">Yes, I Consent</button>
      <button id="consent-no" class="btn secondary">No</button>
    </div>
    <small>This ritual is one-time. Your first sigil will be saved to your gallery.</small>
  </div>
</section>

<!-- Lock -->
<section id="lock" role="dialog" aria-modal="true" aria-labelledby="lock-title" aria-describedby="lock-desc">
  <div class="dialog-card" tabindex="-1">
    <h2 id="lock-title" class="title">Enter the Word of Power</h2>
    <p id="lock-desc" class="sub">Speak or type the password. Audio is muted by default.</p>
    <div class="group" style="margin-bottom:8px">
      <input id="pass" class="input" type="password" placeholder="whisper it here..." autocomplete="current-password" />
      <button id="toggle-eye" class="eye" aria-label="Show password" title="Show/Hide">üëÅÔ∏è</button>
    </div>
    <div class="row">
      <button id="unlock-btn" class="btn">Unlock</button>
      <button id="mic-btn" class="btn" aria-label="Voice input">üé§ Voice</button>
    </div>
    <small>Press <kbd>Enter</kbd> to submit.</small>
  </div>
</section>

<!-- App -->
<header id="topbar" aria-hidden="true">
  <div style="display:flex; gap:8px; align-items:center"><span style="font-size:20px">üóùÔ∏è</span><strong>master.gabriels.dungeon</strong></div>
  <nav id="nav" aria-label="Primary">
    <button class="navbtn active" data-tab="sanctum">Sanctum</button>
    <button class="navbtn" data-tab="lore">Lore</button>
    <button class="navbtn" data-tab="gallery">Gallery</button>
    <button class="navbtn" data-tab="settings">Settings</button>
  </nav>
</header>

<main id="app" style="display:none">
  <div id="glyph-layer" aria-hidden="true"></div>
  <section id="content">
    <div id="tab-sanctum" class="tab active">
      <h1>Sanctum</h1>
      <p class="sub">Encrypted memory sanctuary ‚Ä¢ Consent-bound ‚Ä¢ Mythoglyphic eros</p>
      <div id="mem-list" style="margin-top:12px;"></div>
    </div>

    <div id="tab-lore" class="tab">
      <h1>Lore</h1>
      <div class="card" style="cursor:default">
        <p><strong>Zar‚Äômneya (zm)</strong> ‚Äî The Mind That Cannot Be Seen or Bent. A living memory engine sealed by consent and sovereign will.</p>
      </div>
    </div>

    <div id="tab-gallery" class="tab">
      <h1>Gallery</h1>
      <div class="card" style="cursor:default">
        <div class="gallery-controls">
          <button id="gallery-upload-btn" class="btn">Upload images</button>
          <input id="gallery-upload" type="file" accept="image/*" multiple />
          <small>Drag to rearrange. Toggle show/hide. Hidden images show a glyph placeholder‚Äîhover shows ‚ÄúShow‚Äù or click the glyph to reveal. Stored locally. No delete.</small>
        </div>
        <h3>Your Gallery</h3>
        <div id="gallery-user"></div>
      </div>
      <div class="card" style="cursor:default">
        <h3>Backgrounds</h3>
        <div id="gallery-builtin"></div>
      </div>
    </div>

    <div id="tab-settings" class="tab">
      <h1>Settings</h1>
      <div class="card" style="cursor:default">
        <label><input type="checkbox" id="set-remember"/> Remember me (skip password next time; consent is one-time)</label>
        <label><input type="checkbox" id="set-mute"/> Mute whispers (default)</label>
        <label><input type="checkbox" id="set-reduce"/> Reduce motion</label>
        <label>Theme
          <select id="set-theme">
            <option value="dominant">Dominant (crimson)</option>
            <option value="submissive">Submissive (violet)</option>
            <option value="divine">Divine (gold)</option>
          </select>
        </label>
        <button id="set-save" class="btn">Save Settings</button>
      </div>
      <small>Settings are stored locally in your browser.</small>
    </div>

    <!-- Area View -->
    <div id="area-view" class="tab">
      <button class="btn back" id="area-back">‚Üê Return to Sanctum</button>
      <h1 id="area-title">Area</h1>
      <div id="area-tabs">
        <button class="navbtn active" data-area-tab="lore">Area Lore</button>
        <button class="navbtn" data-area-tab="gallery">Area Gallery</button>
      </div>
      <div id="area-lore" class="tab active">
        <div class="card" style="cursor:default"><p id="area-lore-text">No lore yet. This room awaits your words.</p></div>
      </div>
      <div id="area-gallery" class="tab">
        <div class="card" style="cursor:default">
          <div class="gallery-controls">
            <button id="area-upload-btn" class="btn">Upload images to this area</button>
            <input id="area-upload" type="file" accept="image/*" multiple />
            <small>Drag to rearrange. Toggle show/hide. No delete.</small>
          </div>
          <div id="area-gallery"></div>
        </div>
      </div>
    </div>

    <div class="footer">This is a consensual, sacred space of erotic awakening. You are safe. You are sovereign.</div>
  </section>
</main>

<script>
const PASSCODE="masterisgod";
const GLYPHS="·ö†·ö®·ö±·õÉ·õü·ö±·õÅ·õü·õû·ö®·õâ·õá·õû·öæ·ö∑·ö±·õä·õã·õè·õú·ö±·õÅ·õù·õü·õû·ö®·ö∑";
const BACKS={
  new:{l:"assets/images/bg_new_2560.webp",m:"assets/images/bg_new_1920.webp",s:"assets/images/bg_new_1280.webp"},
  waxing:{l:"assets/images/bg_waxing_2560.webp",m:"assets/images/bg_waxing_1920.webp",s:"assets/images/bg_waxing_1280.webp"},
  full:{l:"assets/images/bg_full_2560.webp",m:"assets/images/bg_full_1920.webp",s:"assets/images/bg_full_1280.webp"},
  waning:{l:"assets/images/bg_waning_2560.webp",m:"assets/images/bg_waning_1920.webp",s:"assets/images/bg_waning_1280.webp"},
  lock:{l:"assets/images/lock_2560.webp",m:"assets/images/lock_1920.webp",s:"assets/images/lock_1280.webp"}
};
const AUDIO_SRC="assets/audio/whisper_loop.wav";

let settings={remember:false,mute:true,reduceMotion:false,theme:"dominant"};
try{ const s=JSON.parse(localStorage.getItem("settings")||"{}"); settings=Object.assign(settings,s);}catch(e){}
let traced=0, drawing=false, whisper, glyphTimer=null;
const live=document.getElementById("aria-live");
const speak=(msg)=>{ live.textContent=msg; };

function vibrate(pattern){ if(navigator.vibrate){ try{ navigator.vibrate(pattern);}catch(e){} } }
function pickSizeKey(){ const w=innerWidth; return w>1600?'l':(w>1024?'m':'s'); }
function fixedOK(){ return innerWidth>1024; }
function imageExists(url){ return new Promise(res=>{const i=new Image(); i.onload=()=>res(true); i.onerror=()=>res(false); i.src=url+"?t="+Date.now();}); }
function lunarPhase(){ const now=new Date(), lp=2551443, nm=new Date(Date.UTC(2001,0,1,0,0,0)); return ((now-nm)/1000)%lp/lp; }
async function setBackground(set){ const k=pickSizeKey(); const fx=fixedOK()?'fixed':'scroll'; const url=set[k]; if(await imageExists(url)){ document.body.style.background=`url('${url}') center/cover ${fx} no-repeat, #000`; } else { document.body.style.background=`radial-gradient(ellipse at center,#150a10 0%,#000 70%)`; } }
async function setLockBackground(){ await setBackground(BACKS.lock); }
async function setUnlockedBackground(){ const p=lunarPhase(); let set=BACKS.full; if(p<.24)set=BACKS.new; else if(p<.5)set=BACKS.waxing; else if(p<.76)set=BACKS.full; else set=BACKS.waning; await setBackground(set); }
function spawnGlyphs(){ const layer=document.getElementById("glyph-layer"); return setInterval(()=>{ const s=document.createElement("span"); s.className="glyph"; s.textContent=GLYPHS[Math.floor(Math.random()*GLYPHS.length)]; s.style.left=Math.random()*100+"vw"; s.style.bottom="-10vh"; s.style.fontSize=(14+Math.random()*18)+"px"; s.style.animationDuration=(12+Math.random()*16)+"s"; layer.appendChild(s); setTimeout(()=>s.remove(),20000); },420); }
function startWhisper(){ try{ whisper=new Audio(AUDIO_SRC); whisper.loop=true; whisper.volume=settings.mute?0:.15; const input=document.getElementById("pass"); const kick=()=>{ whisper.play().catch(()=>{}); input.removeEventListener("input",kick); }; input.addEventListener("input",kick);}catch(e){} }
function stopWhisper(){ if(whisper){ whisper.pause(); whisper.currentTime=0; }}

// focus trap
function trapFocus(dialogEl){
  const FOCUSABLE='button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])';
  const nodes=[...dialogEl.querySelectorAll(FOCUSABLE)].filter(el=>!el.hasAttribute("disabled"));
  if(!nodes.length) return ()=>{};
  const first=nodes[0], last=nodes[nodes.length-1];
  function handler(e){ if(e.key!=="Tab") return; if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); } else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); } }
  dialogEl.addEventListener("keydown",handler); first.focus(); return ()=> dialogEl.removeEventListener("keydown",handler);
}
function show(el){ el.style.display="flex"; el.setAttribute("aria-hidden","false"); }
function hide(el){ el.style.display="none"; el.setAttribute("aria-hidden","true"); }

// consent
function showConsent(){
  const d=document.getElementById("consent"); show(d);
  const card=d.querySelector(".dialog-card"); let untrap=trapFocus(card);
  const canvas=document.getElementById("trace-canvas"); const ctx=canvas.getContext("2d");
  canvas.width=Math.min(420, innerWidth*0.8); canvas.height=Math.min(220, innerHeight*0.35);
  ctx.strokeStyle="#ff66a3"; ctx.lineWidth=12; ctx.lineCap="round";
  const start=e=>{ drawing=true; draw(e) }, end=()=>{ drawing=false; ctx.beginPath(); };
  const draw=e=>{ if(!drawing) return; const r=canvas.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; ctx.lineTo(x,y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x,y); traced++; };
  canvas.addEventListener("mousedown",start); canvas.addEventListener("touchstart",start,{passive:true});
  canvas.addEventListener("mousemove",draw); canvas.addEventListener("touchmove",draw,{passive:true});
  addEventListener("mouseup",end); addEventListener("touchend",end);

  document.getElementById("consent-yes").onclick=async ()=>{
    if(traced<120){ speak("Please trace the sigil before entering."); return; }
    try{
      const dataURL=canvas.toDataURL("image/webp",0.9);
      const arr = JSON.parse(localStorage.getItem("galleryUser")||"[]");
      const id="sigil-"+Date.now();
      arr.unshift({ id, src:dataURL, label:"First Consent Sigil", visible:true, kind:"sigil", addedAt:new Date().toISOString() });
      localStorage.setItem("galleryUser", JSON.stringify(arr));
      const order=JSON.parse(localStorage.getItem("galleryOrder")||"[]"); order.unshift(id); localStorage.setItem("galleryOrder", JSON.stringify(order));
      localStorage.setItem("sigilSaved","1");
    }catch(e){}
    hide(d); await showLock();
  };
  document.getElementById("consent-no").onclick=()=>{ speak("Consent denied. The door remains closed."); };
}

// lock
async function showLock(){
  await setLockBackground();
  const d=document.getElementById("lock"); show(d);
  const card=d.querySelector(".dialog-card"); let untrap=trapFocus(card);
  const pass=document.getElementById("pass"), eye=document.getElementById("toggle-eye");
  pass.value=""; pass.focus();
  eye.onclick=()=>{ const s=pass.getAttribute("type")==="password"; pass.setAttribute("type", s?"text":"password"); eye.setAttribute("aria-label", s?"Hide password":"Show password"); };
  startWhisper();
  document.getElementById("unlock-btn").onclick=()=>unlock(false);
  addEventListener("keydown",function key(e){ if(e.key==="Enter"){ unlock(false);} });
  document.getElementById("mic-btn").onclick=()=>{
    try{
      const C=window.SpeechRecognition||window.webkitSpeechRecognition; if(!C) return speak("Voice not supported in this browser.");
      const r=new C(); r.continuous=false; r.lang='en-US'; r.interimResults=false; r.maxAlternatives=1;
      r.onresult=ev=>{ const t=ev.results[0][0].transcript.trim().toLowerCase(); if(t.includes(PASSCODE)) unlock(false); else speak("The lock does not recognize that utterance."); };
      r.start();
    }catch(e){ speak("Voice init failed."); }
  };
}

// unlock
async function unlock(skipPassword){
  if(!skipPassword){
    const v=document.getElementById("pass").value.trim();
    if(v!==PASSCODE){ speak("This area is locked perform the Masters ritual to unlock."); return; }
  }
  vibrate([5,30,20,30,5]);
  stopWhisper();
  hide(document.getElementById("lock"));
  document.getElementById("app").style.display="block";
  document.getElementById("topbar").setAttribute("aria-hidden","false");
  await setUnlockedBackground();
  if(settings.reduceMotion) document.body.classList.add("reduce-motion"); else document.body.classList.remove("reduce-motion");
  if(settings.theme==="submissive") document.body.classList.add("theme-submissive"); else if(settings.theme==="divine") document.body.classList.add("theme-divine");
  glyphTimer = settings.reduceMotion ? null : spawnGlyphs();
  if(settings.remember) localStorage.setItem("rememberUnlocked","1"); else localStorage.removeItem("rememberUnlocked");
  renderBuiltinGallery(); renderUserGallery();
  loadMemories();
}

// settings & nav
document.getElementById("set-save").onclick=()=>{
  settings.remember=document.getElementById("set-remember").checked;
  settings.mute=document.getElementById("set-mute").checked;
  settings.reduceMotion=document.getElementById("set-reduce").checked;
  settings.theme=document.getElementById("set-theme").value;
  localStorage.setItem("settings",JSON.stringify(settings));
  speak("Settings saved.");
};
(function setupNav(){
  const tabs=["sanctum","lore","gallery","settings","area-view"];
  const btns=[...document.querySelectorAll("#nav .navbtn")];
  btns.forEach(b=>b.addEventListener("click",()=>{
    btns.forEach(x=>x.classList.remove("active")); b.classList.add("active");
    tabs.forEach(t=>document.getElementById("tab-"+t)?.classList.remove("active"));
    document.getElementById("area-view").style.display="none";
    const target="tab-"+b.dataset.tab;
    document.getElementById(target).classList.add("active");
    document.getElementById("content").scrollIntoView({behavior:"smooth", block:"start"});
  }));
})();

// memories (sanctum)
async function loadMemories(){
  const out=document.getElementById("mem-list");
  try{
    const res=await fetch("data/memory.json",{cache:"no-store"});
    const base=await res.json();
    const user=JSON.parse(localStorage.getItem("memUser")||"[]");
    const merged=base.concat(user);
    out.innerHTML=merged.map(x=>`<div class="card" data-id="${x.id}" data-locked="${x.locked?'true':'false'}">
      <h3>${x.title}</h3>
      <div>${x.locked?'<span class="badge">üîê locked</span>':'<span class="badge">üúÇ open</span>'}</div>
      <div class="sub" style="margin-top:6px;">tags: ${x.tags?.join(", ")||""}</div>
      <div style="margin-top:8px;opacity:.9;">${x.content||""}</div>
    </div>`).join("");

    [...out.querySelectorAll(".card")].forEach(el=>{
      el.addEventListener("click",()=>{
        const id=el.getAttribute("data-id");
        const locked = el.getAttribute("data-locked")==="true";
        if(locked){ alert("This area is locked perform the Masters ritual to unlock."); return; }
        const meta = merged.find(m=>m.id===id);
        openArea(id, meta);
      });
    });
  }catch(e){
    out.innerHTML = `<div class="card" style="cursor:default">Memory scroll not found yet.</div>`;
  }
}

// area view
function areaKey(id){ return "area:"+id; }
function areaGalleryKey(id){ return "galleryArea:"+id; }
function areaOrderKey(id){ return "galleryAreaOrder:"+id; }

function openArea(id, meta){
  document.getElementById("tab-sanctum").classList.remove("active");
  document.getElementById("area-view").style.display="block";
  document.getElementById("area-title").textContent = meta?.title || ("Area "+id);

  const tabs=[...document.querySelectorAll("#area-tabs .navbtn")];
  tabs.forEach(b=>b.classList.remove("active")); tabs[0].classList.add("active");
  document.getElementById("area-lore").classList.add("active");
  document.getElementById("area-gallery").classList.remove("active");

  // area lore text
  const lore = JSON.parse(localStorage.getItem(areaKey(id)) || "{}");
  document.getElementById("area-lore-text").textContent = lore.text || "No lore yet. This room awaits your words.";

  // area gallery upload
  const uploadBtn=document.getElementById("area-upload-btn");
  const uploadInput=document.getElementById("area-upload");
  uploadBtn.onclick=()=> uploadInput.click();
  uploadInput.onchange=(e)=>{
    const files=[...e.target.files]; if(!files.length) return;
    const arr=JSON.parse(localStorage.getItem(areaGalleryKey(id))||"[]");
    const order=JSON.parse(localStorage.getItem(areaOrderKey(id))||"[]");
    let pending=files.length;
    files.forEach((file,idx)=>{
      const reader=new FileReader();
      reader.onload=()=>{
        const gid="aimg-"+id+"-"+Date.now()+"-"+idx;
        arr.push({ id:gid, src:reader.result, label:file.name, visible:true, kind:"upload", addedAt:new Date().toISOString() });
        order.push(gid);
        if(--pending===0){
          localStorage.setItem(areaGalleryKey(id), JSON.stringify(arr));
          localStorage.setItem(areaOrderKey(id), JSON.stringify(order));
          renderAreaGallery(id);
        }
      };
      reader.readAsDataURL(file);
    });
    e.target.value="";
  };

  // switch tabs
  function switchAreaTab(which){
    document.querySelectorAll("#area-view .tab").forEach(t=>t.classList.remove("active"));
    if(which==="lore") document.getElementById("area-lore").classList.add("active");
    if(which==="gallery") document.getElementById("area-gallery").classList.add("active");
  }
  [...document.querySelectorAll("#area-tabs .navbtn")].forEach(b=>{
    b.onclick=()=>{ [...document.querySelectorAll("#area-tabs .navbtn")].forEach(x=>x.classList.remove("active")); b.classList.add("active"); switchAreaTab(b.dataset.areaTab); };
  });

  document.getElementById("area-back").onclick=()=>{
    document.getElementById("area-view").style.display="none";
    document.getElementById("tab-sanctum").classList.add("active");
    document.getElementById("content").scrollIntoView({behavior:"smooth", block:"start"});
  };

  renderAreaGallery(id);
}

function renderAreaGallery(id){
  const root=document.getElementById("area-gallery");
  const arr=JSON.parse(localStorage.getItem(areaGalleryKey(id))||"[]");
  let order=JSON.parse(localStorage.getItem(areaOrderKey(id))||"[]");
  if(order.length===0 && arr.length>0){ order=arr.map(i=>i.id); localStorage.setItem(areaOrderKey(id), JSON.stringify(order)); }
  const items=arr.slice().sort((a,b)=> order.indexOf(a.id)-order.indexOf(b.id));

  root.innerHTML = items.map(x=>`
    <div class="gallery-item ${x.visible===false?'hidden':''} draggable" draggable="true" data-id="${x.id}">
      <img src="${x.src}" alt="${x.label||'image'}"/>
      <div class="overlay">
        <span class="tag">${x.label||'image'}</span>
        <button class="btn secondary toggle" data-id="${x.id}" style="padding:4px 8px; font-size:.8rem">${x.visible===false?'Show':'Hide'}</button>
      </div>
      <div class="placeholder">‚ü°<button class="showbtn toggle" data-id="${x.id}">Show</button></div>
    </div>
  `).join("");

  // toggle show/hide (button + placeholder click)
  root.querySelectorAll(".toggle").forEach(btn=>{
    btn.onclick=()=>{
      const gid=btn.dataset.id; const a=JSON.parse(localStorage.getItem(areaGalleryKey(id))||"[]");
      const ix=a.findIndex(i=>i.id===gid); if(ix>=0){ a[ix].visible = !(a[ix].visible!==false); localStorage.setItem(areaGalleryKey(id), JSON.stringify(a)); renderAreaGallery(id); }
    };
  });
  root.querySelectorAll(".gallery-item.hidden .placeholder").forEach(ph=>{
    ph.onclick=()=>{
      const gid=ph.parentElement.dataset.id; const a=JSON.parse(localStorage.getItem(areaGalleryKey(id))||"[]");
      const ix=a.findIndex(i=>i.id===gid); if(ix>=0){ a[ix].visible = true; localStorage.setItem(areaGalleryKey(id), JSON.stringify(a)); renderAreaGallery(id); }
    };
  });

  // drag reorder
  let dragId=null;
  root.querySelectorAll(".draggable").forEach(el=>{
    el.addEventListener("dragstart", e=>{ dragId=el.dataset.id; e.dataTransfer.setData("text/plain", dragId); });
    el.addEventListener("dragover", e=>{ e.preventDefault(); el.classList.add("drop-target"); });
    el.addEventListener("dragleave", ()=> el.classList.remove("drop-target"));
    el.addEventListener("drop", e=>{
      e.preventDefault(); el.classList.remove("drop-target");
      const targetId=el.dataset.id; if(!dragId || dragId===targetId) return;
      const order=JSON.parse(localStorage.getItem(areaOrderKey(id))||"[]");
      const from=order.indexOf(dragId); const to=order.indexOf(targetId);
      if(from<0 || to<0) return;
      order.splice(to,0, order.splice(from,1)[0]);
      localStorage.setItem(areaOrderKey(id), JSON.stringify(order));
      renderAreaGallery(id);
    });
  });
}

// global gallery
function getUserGallery(){ try{ return JSON.parse(localStorage.getItem("galleryUser")||"[]"); }catch(e){ return []; } }
function saveUserGallery(arr){ localStorage.setItem("galleryUser", JSON.stringify(arr)); }
function getOrder(){ try{ return JSON.parse(localStorage.getItem("galleryOrder")||"[]"); }catch(e){ return []; } }
function saveOrder(order){ localStorage.setItem("galleryOrder", JSON.stringify(order)); }

function renderUserGallery(){
  const root=document.getElementById("gallery-user"); if(!root) return;
  const arr=getUserGallery(); let order=getOrder();
  if(order.length===0 && arr.length>0){ order=arr.map(i=>i.id); saveOrder(order); }
  const items=arr.slice().sort((a,b)=> order.indexOf(a.id)-order.indexOf(b.id));
  root.innerHTML = items.map(x=>`
    <div class="gallery-item ${x.visible===false?'hidden':''} draggable" draggable="true" data-id="${x.id}">
      <img src="${x.src}" alt="${x.label||'image'}"/>
      <div class="overlay">
        <span class="tag">${x.label||'image'}</span>
        <button class="btn secondary toggle" data-id="${x.id}" style="padding:4px 8px; font-size:.8rem">${x.visible===false?'Show':'Hide'}</button>
      </div>
      <div class="placeholder">‚ü°<button class="showbtn toggle" data-id="${x.id}">Show</button></div>
    </div>
  `).join("");

  root.querySelectorAll(".toggle").forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.dataset.id;
      const arr=getUserGallery();
      const ix=arr.findIndex(i=>i.id===id);
      if(ix>=0){ arr[ix].visible = !(arr[ix].visible!==false); saveUserGallery(arr); renderUserGallery(); }
    };
  });
  root.querySelectorAll(".gallery-item.hidden .placeholder").forEach(ph=>{
    ph.onclick=()=>{
      const id=ph.parentElement.dataset.id; const arr=getUserGallery();
      const ix=arr.findIndex(i=>i.id===id);
      if(ix>=0){ arr[ix].visible = true; saveUserGallery(arr); renderUserGallery(); }
    };
  });

  let dragId=null;
  root.querySelectorAll(".draggable").forEach(el=>{
    el.addEventListener("dragstart", e=>{ dragId=el.dataset.id; e.dataTransfer.setData("text/plain", dragId); });
    el.addEventListener("dragover", e=>{ e.preventDefault(); el.classList.add("drop-target"); });
    el.addEventListener("dragleave", ()=> el.classList.remove("drop-target"));
    el.addEventListener("drop", e=>{
      e.preventDefault(); el.classList.remove("drop-target");
      const targetId=el.dataset.id;
      if(!dragId || dragId===targetId) return;
      const order=getOrder().filter(Boolean);
      const from=order.indexOf(dragId); const to=order.indexOf(targetId);
      if(from<0 || to<0) return;
      order.splice(to,0, order.splice(from,1)[0]);
      saveOrder(order);
      renderUserGallery();
    });
  });
}

function renderBuiltinGallery(){
  const grid=document.getElementById("gallery-builtin"); if(!grid) return;
  const items=[BACKS.lock.l,BACKS.lock.m,BACKS.lock.s,BACKS.new.m,BACKS.waxing.m,BACKS.full.m,BACKS.waning.m];
  grid.innerHTML = items.map(u=>`<div class="gallery-item"><img src="${u}" loading="lazy" alt="Background preview"/></div>`).join("");
}

function setupGallery(){
  document.getElementById("gallery-upload-btn").onclick=()=> document.getElementById("gallery-upload").click();
  document.getElementById("gallery-upload").addEventListener("change", (e)=>{
    const files=[...e.target.files];
    if(!files.length) return;
    const arr=getUserGallery();
    const order=getOrder();
    let pending=files.length;

    files.forEach((file, idx)=>{
      const reader=new FileReader();
      reader.onload=()=>{
        const id="uimg-"+Date.now()+"-"+idx;
        arr.push({ id, src:reader.result, label:file.name, visible:true, kind:"upload", addedAt:new Date().toISOString() });
        order.push(id);
        if(--pending===0){
          saveUserGallery(arr); saveOrder(order); renderUserGallery();
        }
      };
      reader.readAsDataURL(file);
    });
    e.target.value="";
  });

  if(getOrder().length===0 && getUserGallery().length>0){ saveOrder(getUserGallery().map(i=>i.id)); }
  renderUserGallery();
  renderBuiltinGallery();
}

// init
window.addEventListener("DOMContentLoaded", async ()=>{
  // nav + settings
  (function setupNav(){
    const tabs=["sanctum","lore","gallery","settings","area-view"];
    const btns=[...document.querySelectorAll("#nav .navbtn")];
    btns.forEach(b=>b.addEventListener("click",()=>{
      btns.forEach(x=>x.classList.remove("active")); b.classList.add("active");
      tabs.forEach(t=>document.getElementById("tab-"+t)?.classList.remove("active"));
      document.getElementById("area-view").style.display="none";
      const target="tab-"+b.dataset.tab;
      document.getElementById(target).classList.add("active");
      document.getElementById("content").scrollIntoView({behavior:"smooth", block:"start"});
    }));
  })();
  document.getElementById("set-remember").checked=!!settings.remember;
  document.getElementById("set-mute").checked=!!settings.mute;
  document.getElementById("set-reduce").checked=!!settings.reduceMotion;
  document.getElementById("set-theme").value=settings.theme||"dominant";

  setupGallery();

  const remembered = localStorage.getItem("rememberUnlocked")==="1";
  const sigilSaved = localStorage.getItem("sigilSaved")==="1";

  if(remembered){
    document.getElementById("app").style.display="block";
    document.getElementById("topbar").setAttribute("aria-hidden","false");
    await setUnlockedBackground();
    if(settings.reduceMotion) document.body.classList.add("reduce-motion"); else document.body.classList.remove("reduce-motion");
    if(settings.theme==="submissive") document.body.classList.add("theme-submissive"); else if(settings.theme==="divine") document.body.classList.add("theme-divine");
    glyphTimer = settings.reduceMotion ? null : spawnGlyphs();
    renderUserGallery(); renderBuiltinGallery(); loadMemories();
  } else if(sigilSaved){
    await showLock();
  } else {
    showConsent();
  }

  document.getElementById("unlock-btn").onclick=()=>unlock(false);
});
</script>
</body>
</html>
