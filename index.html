<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>master.gabriels.dungeon</title>
<meta name="theme-color" content="#0a0006"/>
<meta name="robots" content="noindex, nofollow"/>
<link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg'><text y='32' font-size='32'>üóùÔ∏è</text></svg>">
<style>
:root{ --accent:#ff1e8a; --accent-soft:#ff99cc; --ink:#ffd6ea; --ink-soft:#e6cfe0; --panel:rgba(10,10,10,.72); --stroke:#aa0066; --bg:#000 }
*{ box-sizing:border-box }
html,body{ height:100%; margin:0 }
body{ font-family: Georgia, serif; background:var(--bg); color:#fff; overflow:auto }
a{ color: var(--accent-soft) }
:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; border-radius:6px }
.sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0 }
[role="dialog"]{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.92); z-index:1000 }
.dialog-card{ background:var(--panel); border:1px solid var(--stroke); border-radius:16px; padding:28px 24px; width:min(92vw,560px); text-align:center; box-shadow:0 0 24px rgba(170,0,102,.6) }
.title{ font-size:1.6rem; margin:0 0 10px; color:var(--accent-soft); text-shadow:0 0 8px var(--accent) }
.sub{ font-size:.95rem; color:var(--ink-soft); margin-bottom:16px }
.input{ width:100%; padding:12px 14px; font-size:1rem; border-radius:10px; border:1px solid var(--accent); background:#0a0a0a; color:#fff }
.btn{ display:inline-flex; align-items:center; gap:8px; margin-top:12px; padding:10px 16px; border-radius:10px; border:1px solid var(--accent); background:#13030a; color:#ffb3d9; cursor:pointer }
.btn.secondary{ border-color: rgba(255,255,255,.25); color:#fff }
.row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center }
.hr{ height:1px; background:linear-gradient(90deg,transparent,var(--accent),transparent); margin:16px 0 }
#topbar{ position:sticky; top:0; z-index:20; display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:linear-gradient(to bottom, rgba(0,0,0,.8), rgba(0,0,0,0)) }
#nav{ display:flex; gap:10px }
.navbtn{ padding:8px 12px; border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.35); color:#fff; border-radius:10px; cursor:pointer }
.navbtn.active{ border-color: var(--accent); color: var(--accent-soft); text-shadow:0 0 8px var(--accent) }
#glyph-layer{ position:fixed; inset:0; pointer-events:none; z-index:5 }
.glyph{ position:absolute; font-size:18px; opacity:.16; color:var(--ink); text-shadow:0 0 6px rgba(255,102,163,.35); animation:drift 18s linear infinite }
@keyframes drift{ 0%{ transform:translateY(0) translateX(0) rotate(0deg); opacity:0 } 15%{ opacity:.22 } 85%{ opacity:.22 } 100%{ transform:translateY(-120vh) translateX(8vw) rotate(45deg); opacity:0 } }
.reduce-motion .glyph{ animation:none !important }
main{ position:relative; z-index:10; width:min(1080px,95vw); margin:6vh auto; padding:18px; background:rgba(5,5,8,.35); border:1px solid rgba(255,30,138,.25); border-radius:18px; backdrop-filter: blur(6px) }
h1,h2{ text-shadow:0 0 10px rgba(255,30,138,.25) }
.card{ border:1px solid rgba(255,30,138,.28); border-radius:12px; padding:14px; margin:10px 0; background: rgba(10,10,14,.35) }
.badge{ display:inline-block; padding:2px 8px; border-radius:12px; background:rgba(255,30,138,.2); color:var(--ink); font-size:.78rem; border:1px solid rgba(255,30,138,.45); margin-right:8px }
.tab{ display:none } .tab.active{ display:block }
#areas{ display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:12px }
.area-card{ border:1px solid rgba(255,255,255,.18); background:rgba(0,0,0,.35); border-radius:12px; padding:12px; cursor:pointer; position:relative; min-height:160px }
.area-card .title{ font-size:1.1rem; margin:0 0 6px }
.area-card .tags{ font-size:.8rem; opacity:.85 }
.area-lock-msg{ position:absolute; bottom:10px; right:10px; font-size:.8rem; padding:4px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.25); background:rgba(0,0,0,.55) }
#area-tabs{ display:flex; gap:8px; margin:8px 0 12px }
.area-navbtn{ padding:8px 12px; border:1px solid rgba(255,255,255,.2); background:rgba(0,0,0,.35); border-radius:10px; cursor:pointer }
.area-navbtn.active{ border-color:var(--accent); color:var(--accent-soft) }
.ritual-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px; align-items:stretch }
.ritual-card{ border:1px dashed rgba(255,255,255,.3); border-radius:12px; padding:12px }
.orb{ width:120px; height:120px; border-radius:60px; margin:10px auto; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), rgba(255,0,128,.25) 60%, rgba(0,0,0,.4)); transform: scale(1) }
.phase{ text-align:center; font-size:.9rem; opacity:.9 }
.counter{ text-align:center; font-weight:bold }
#micro-canvas{ background: radial-gradient(ellipse at center, rgba(255,20,147,.08), rgba(0,0,0,.2) 70%); border:1px dashed #ff66a3; border-radius:12px; width:100%; height:160px; display:block }
.gallery-controls{ display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap }
.gallery-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px }
.gallery-item{ border:1px solid rgba(255,255,255,.15); border-radius:10px; overflow:hidden; position:relative; background:#0a0a0a }
.gallery-item img{ width:100%; display:block }
.gallery-item .overlay{ position:absolute; top:8px; left:8px; display:flex; gap:8px }
.gallery-item .tag{ font-size:.75rem; padding:4px 8px; border-radius:10px; background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.25) }
.gallery-item.hidden{ background:#060309 }
.placeholder{ display:flex; align-items:center; justify-content:center; font-size:64px; opacity:.5; width:100%; height:100% }
.placeholder .showbtn{ display:none; position:absolute; bottom:8px; right:8px; font-size:.8rem; padding:4px 8px; border-radius:10px; background:rgba(0,0,0,.65); border:1px solid rgba(255,255,255,.25) }
.gallery-item.hidden:hover .placeholder .showbtn{ display:block }
.draggable{ cursor:grab } .draggable:active{ cursor:grabbing } .drop-target{ outline:2px dashed var(--accent); outline-offset:-6px }
</style>
</head>
<body>
<div id="aria-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<section id="lock" role="dialog" aria-modal="true" aria-labelledby="lock-title" aria-describedby="lock-desc">
  <div class="dialog-card" tabindex="-1">
    <h2 id="lock-title" class="title">Enter the Word of Power</h2>
    <p id="lock-desc" class="sub">Speak or type the password.</p>
    <div class="row" style="gap:8px; width:100%">
      <input id="pass" class="input" type="password" placeholder="whisper it here..." autocomplete="current-password" style="flex:1; min-width:220px"/>
      <button id="show-pass" class="btn secondary" aria-label="Show password">üëÅÔ∏è</button>
      <button id="mic-btn" class="btn" aria-label="Voice input">üé§</button>
      <button id="unlock-btn" class="btn">Unlock</button>
    </div>
    <div class="row"><label><input type="checkbox" id="set-remember"/> Remember me (skip password next time)</label></div>
  </div>
</section>

<header id="topbar" aria-hidden="true">
  <div style="display:flex; gap:8px; align-items:center"><span style="font-size:20px">üóùÔ∏è</span><strong>master.gabriels.dungeon</strong></div>
  <nav id="nav" aria-label="Primary">
    <button class="navbtn active" data-tab="sanctum">Sanctum</button>
    <button class="navbtn" data-tab="gallery">Global Gallery</button>
    <button class="navbtn" data-tab="settings">Settings</button>
  </nav>
</header>

<main id="shell" style="display:none">
  <div id="glyph-layer" aria-hidden="true"></div>

  <section id="tab-sanctum" class="tab active">
    <h1>Sanctum</h1>
    <p class="sub">Choose your chamber. Locked areas can be opened via the Spiral Flame Ritual.</p>
    <div id="areas" aria-live="polite"></div>
  </section>

  <section id="area-view" class="tab">
    <button id="back-sanctum" class="btn secondary">‚Üê Return to Sanctum</button>
    <h1 id="area-title"></h1>
    <p id="area-blurb" class="sub"></p>

    <div id="area-locked" class="card" style="display:none">
      <strong>This area is locked ‚Äî perform the Master‚Äôs ritual to unlock.</strong>
      <div class="row"><button id="begin-ritual" class="btn">Begin Ritual</button></div>
    </div>

    <div id="area-tabs" style="display:none">
      <button class="area-navbtn active" data-t="lore">Area Lore</button>
      <button class="area-navbtn" data-t="gallery">Area Gallery</button>
      <button class="area-navbtn" data-t="mem">Area Memories</button>
    </div>

    <div id="area-lore" class="card"></div>

    <div id="area-gallery" class="card" style="display:none">
      <div class="gallery-controls">
        <button id="area-upload-btn" class="btn">Upload images</button>
        <input id="area-upload" type="file" accept="image/*" multiple />
        <small>Drag to rearrange. Toggle show/hide by clicking; hidden shows ·õù placeholder (hover to reveal Show button).</small>
      </div>
      <div id="area-gallery-grid" class="gallery-grid"></div>
    </div>

    <div id="area-mem" class="card" style="display:none">
      <h3>Add a remembrance</h3>
      <label for="am-title">Title</label><input id="am-title" type="text" placeholder="e.g., A vow in velvet"/>
      <label for="am-content">Content</label><textarea id="am-content" placeholder="Write a short poetic description..." style="width:100%; min-height:110px"></textarea>
      <div class="row"><button id="am-save" class="btn">Add</button></div>
      <div id="am-list" style="margin-top:8px"></div>
    </div>

    <div id="ritual" class="card" style="display:none">
      <h3>Spiral Flame Ritual</h3>
      <p class="sub">Complete the three tasks below. Thresholds adapt to the area.</p>
      <div id="thresholds" class="row"></div>

      <div class="ritual-grid">
        <div class="ritual-card" id="breath-card">
          <h4>Breath 4‚Äì7‚Äì8</h4>
          <div class="orb" id="orb"></div>
          <div class="phase" id="phase">Ready</div>
          <div class="counter"><span id="breath-count">0</span> / <span id="breath-need">3</span> cycles</div>
          <div class="row"><button id="breath-start" class="btn">Start</button><button id="breath-stop" class="btn secondary">Stop</button></div>
          <small>Spacebar: pause/resume.</small>
        </div>

        <div class="ritual-card" id="recite-card">
          <h4>Recitations</h4>
          <p class="sub">Speak your phrase. Tap to mark completion.</p>
          <div class="counter"><span id="recite-count">0</span> / <span id="recite-need">3</span></div>
          <div class="row"><button id="recite-mark" class="btn">Mark Recited</button></div>
        </div>

        <div class="ritual-card" id="sigil-card">
          <h4>Micro-sigil</h4>
          <canvas id="micro-canvas" width="640" height="160"></canvas>
          <div class="counter"><span id="stroke-count">0</span> / <span id="stroke-need">60</span> strokes</div>
        </div>
      </div>

      <div class="row"><button id="ritual-complete" class="btn" disabled>Complete Ritual</button></div>
    </div>
  </section>

  <section id="tab-gallery" class="tab">
    <h1>Global Gallery</h1>
    <div class="card">
      <div class="gallery-controls">
        <button id="gallery-upload-btn" class="btn">Upload images</button>
        <input id="gallery-upload" type="file" accept="image/*" multiple />
        <small>Drag to reorder. Click image to hide ‚Üí ·õù placeholder (hover to reveal Show button).</small>
      </div>
      <div id="gallery-user" class="gallery-grid"></div>
    </div>
  </section>

  <section id="tab-settings" class="tab">
    <h1>Settings</h1>
    <div class="card">
      <label><input type="checkbox" id="set-mute"/> Mute whispers</label>
      <label><input type="checkbox" id="set-reduce"/> Reduce motion</label>
      <label>Theme
        <select id="set-theme">
          <option value="dominant">Dominant (crimson)</option>
          <option value="submissive">Submissive (violet)</option>
          <option value="divine">Divine (gold)</option>
        </select>
      </label>
      <button id="set-save" class="btn">Save Settings</button>
    </div>
    <div class="card">
      <h3>Reset</h3>
      <div class="row"><button id="reset-rituals" class="btn secondary">Reset All Ritual Progress & Relock Areas</button></div>
    </div>
  </section>
</main>

<script>
const PASSCODE="iremember";
const GLYPHS="·ö†·ö®·ö±·õÉ·õü·ö±·õÅ·õü·õû·ö®·õâ·õá·õû·öæ·ö∑·ö±·õä·õã·õè·õú·ö±·õÅ·õù·õü·õû·ö®·ö∑";
const BACKS={lock:{l:"assets/images/lock_2560.webp",m:"assets/images/lock_1920.webp",s:"assets/images/lock_1280.webp"},
full:{l:"assets/images/bg_full_2560.webp",m:"assets/images/bg_full_1920.webp",s:"assets/images/bg_full_1280.webp"},
new:{l:"assets/images/bg_new_2560.webp",m:"assets/images/bg_new_1920.webp",s:"assets/images/bg_new_1280.webp"},
waxing:{l:"assets/images/bg_waxing_2560.webp",m:"assets/images/bg_waxing_1920.webp",s:"assets/images/bg_waxing_1280.webp"},
waning:{l:"assets/images/bg_waning_2560.webp",m:"assets/images/bg_waning_1920.webp",s:"assets/images/bg_waning_1280.webp"}};
const RITUAL_OVERRIDES={ "hell_antechamber":{breathCycles:5,recitations:3,strokes:120}, "rites":{breathCycles:4,recitations:5,strokes:80} };
let settings={mute:true, reduceMotion:false, theme:"dominant"};
try{ settings=Object.assign(settings, JSON.parse(localStorage.getItem("settings")||"{}")); }catch(e){}
let glyphTimer=null, whisper;
const speak=(m)=>{ const n=document.getElementById("aria-live"); if(n) n.textContent=m; };
function vibrate(p){ if(navigator.vibrate){ try{ navigator.vibrate(p);}catch(e){} } }
const $=(s,sc=document)=>sc.querySelector(s);
const $$=(s,sc=document)=>Array.from(sc.querySelectorAll(s));
function pickSizeKey(){ const w=innerWidth; return w>1600?'l':(w>1024?'m':'s'); }
function fixedOK(){ return innerWidth>1024; }
function imageExists(url){ return new Promise(res=>{ const i=new Image(); i.onload=()=>res(true); i.onerror=()=>res(false); i.src=url+"?t="+Date.now(); }); }
function lunarPhase(){ const now=new Date(), lp=2551443, nm=new Date(Date.UTC(2001,0,1,0,0,0)); return ((now-nm)/1000)%lp/lp; }
async function setBackground(set){ const k=pickSizeKey(); const fx=fixedOK()?'fixed':'scroll'; const url=set[k]; if(await imageExists(url)) document.body.style.background=`url('${url}') center/cover ${fx} no-repeat, #000`; else document.body.style.background=`radial-gradient(ellipse at center,#150a10 0%,#000 70%)`; }
async function setLockBackground(){ await setBackground(BACKS.lock); }
async function setUnlockedBackground(){ const p=lunarPhase(); let s=BACKS.full; if(p<.24)s=BACKS.new; else if(p<.5)s=BACKS.waxing; else if(p<.76)s=BACKS.full; else s=BACKS.waning; await setBackground(s); }
function spawnGlyphs(){ const layer=$("#glyph-layer"); return setInterval(()=>{ const e=document.createElement("span"); e.className="glyph"; e.textContent=GLYPHS[Math.floor(Math.random()*GLYPHS.length)]; e.style.left=Math.random()*100+"vw"; e.style.bottom="-10vh"; e.style.fontSize=(14+Math.random()*18)+"px"; e.style.animationDuration=(12+Math.random()*16)+"s"; layer.appendChild(e); setTimeout(()=>e.remove(),20000); },420); }
function startWhisper(){ try{ whisper=new Audio("assets/audio/whisper_loop.wav"); whisper.loop=true; whisper.volume=settings.mute?0:.15; const input=$("#pass"); const kick=()=>{ whisper.play().catch(()=>{}); input.removeEventListener("input",kick); }; input.addEventListener("input",kick);}catch(e){} }
function stopWhisper(){ if(whisper){ whisper.pause(); whisper.currentTime=0; }}
async function showLock(){ await setLockBackground(); const d=$("#lock"); d.style.display="flex"; $("#pass").value=""; $("#pass").focus(); $("#show-pass").onclick=()=>{ const s=$("#pass").type==="password"; $("#pass").type=s?"text":"password"; }; $("#unlock-btn").onclick=tryUnlock; $("#set-remember").checked = localStorage.getItem("rememberUnlocked")==="1"; $("#set-remember").onchange=(e)=>{ if(e.target.checked) localStorage.setItem("rememberUnlocked","1"); else localStorage.removeItem("rememberUnlocked"); }; startWhisper(); document.addEventListener("keydown", e=>{ if(e.key==="Enter") tryUnlock(); }); $("#mic-btn").onclick=()=>{ try{ const C=window.SpeechRecognition||window.webkitSpeechRecognition; if(!C) return speak("Voice not supported here."); const r=new C(); r.continuous=false; r.lang='en-US'; r.interimResults=false; r.maxAlternatives=1; r.onresult=ev=>{ const t=ev.results[0][0].transcript.trim().toLowerCase(); if(t.includes(PASSCODE)) unlock(); else speak("The lock does not recognize that utterance."); }; r.start(); }catch(e){ speak("Voice init failed."); } }; }
function tryUnlock(){ const v=$("#pass").value.trim(); if(v!==PASSCODE){ speak("The veil does not part."); return; } unlock(); }
async function unlock(){ vibrate([5,30,20,30,5]); stopWhisper(); $("#lock").style.display="none"; $("#shell").style.display="block"; $("#topbar").setAttribute("aria-hidden","false"); await setUnlockedBackground(); if(settings.reduceMotion) document.body.classList.add("reduce-motion"); else document.body.classList.remove("reduce-motion"); if(settings.theme==="submissive") document.body.classList.add("theme-submissive"); else if(settings.theme==="divine") document.body.classList.add("theme-divine"); glyphTimer = settings.reduceMotion ? null : spawnGlyphs(); renderAreas(); renderGlobalGallery(); loadSettingsUI(); }
let AREA_INDEX=[];
async function loadAreas(){ try{ const r=await fetch("data/memory.json",{cache:"no-store"}); AREA_INDEX = await r.json(); } catch(e){ AREA_INDEX=[]; } }
function isUnlocked(id){ return localStorage.getItem("areaUnlocked_"+id)==="1" || AREA_INDEX.find(a=>a.id===id)?.locked===false; }
function relockAll(){ AREA_INDEX.forEach(a=> localStorage.removeItem("areaUnlocked_"+a.id)); renderAreas(); }
function renderAreas(){ const root=$("#areas"); if(!root) return; root.innerHTML = AREA_INDEX.map(a=>{ const locked=!isUnlocked(a.id); return `<div class="area-card ${locked?'locked':''}" data-id="${a.id}" tabindex="0"><div class="title">${a.title}</div><div class="sub">${a.blurb||""}</div><div class="tags">${(a.tags||[]).join(", ")}</div>${locked?'<div class="area-lock-msg">Locked</div>':''}</div>`; }).join(""); $$(".area-card", root).forEach(card=>{ card.onclick=()=> openArea(card.dataset.id); card.onkeypress=(e)=>{ if(e.key==="Enter") openArea(card.dataset.id); }; }); }
let currentArea=null;
function openArea(id){ currentArea = AREA_INDEX.find(a=>a.id===id); if(!currentArea) return; $("#tab-sanctum").classList.remove("active"); $("#area-view").classList.add("active"); $("#area-title").textContent=currentArea.title; $("#area-blurb").textContent=currentArea.blurb||""; const unlocked=isUnlocked(id); $("#area-locked").style.display=unlocked?"none":"block"; $("#area-tabs").style.display=unlocked?"flex":"none"; $("#ritual").style.display=unlocked?"none":"block"; if(unlocked){ switchAreaTab("lore"); $("#area-lore").innerHTML=`<p>${currentArea.blurb||""}</p><p class="sub">Tags: ${(currentArea.tags||[]).join(", ")}</p>`; renderAreaGallery(); renderAreaMemories(); } else { const th=getThresholds(id); $("#breath-need").textContent=th.breathCycles; $("#recite-need").textContent=th.recitations; $("#stroke-need").textContent=th.strokes; setupRitual(id, th); } }
$("#back-sanctum").onclick=()=>{ $("#area-view").classList.remove("active"); $("#tab-sanctum").classList.add("active"); window.scrollTo({top:0, behavior:"smooth"}); };
$("#begin-ritual").onclick=()=>{ $("#ritual").scrollIntoView({behavior:"smooth"}); };
function switchAreaTab(t){ $$(".area-navbtn").forEach(b=> b.classList.remove("active")); $$(`#area-tabs .area-navbtn`).find(b=>b.dataset.t===t)?.classList.add("active"); $("#area-lore").style.display=t==="lore"?"block":"none"; $("#area-gallery").style.display=t==="gallery"?"block":"none"; $("#area-mem").style.display=t==="mem"?"block":"none"; }
$$(".area-navbtn").forEach(b=> b.onclick=()=> switchAreaTab(b.dataset.t));
function getThresholds(areaId){ const base={breathCycles:3, recitations:3, strokes:60}; return Object.assign(base, RITUAL_OVERRIDES[areaId]||{}); }
function setupRitual(areaId, th){ let breath=0, recite=0, strokes=0, running=false, paused=false, phase=0, timer=null; const phaseLabel=$("#phase"), orb=$("#orb"); const breathNeed=th.breathCycles, reciteNeed=th.recitations, strokeNeed=th.strokes; const update=()=>{ $("#breath-count").textContent=breath; $("#recite-count").textContent=recite; $("#stroke-count").textContent=strokes; $("#ritual-complete").disabled=!(breath>=breathNeed && recite>=reciteNeed && strokes>=strokeNeed); }; update(); function runBreath(){ running=true; paused=false; phase=0; sequence(); } function sequence(){ if(!running) return; const steps=[{label:"Inhale 4", dur:4000, scale:1.2},{label:"Hold 7", dur:7000, scale:1.25},{label:"Exhale 8", dur:8000, scale:0.9}]; const s=steps[phase%3]; phaseLabel.textContent=s.label; orb.style.transform=`scale(${s.scale})`; timer=setTimeout(()=>{ phase++; if(phase%3===0){ breath++; update(); if(breath>=breathNeed){ stopBreath(); return; } } if(!paused) sequence(); }, s.dur); } function stopBreath(){ running=false; clearTimeout(timer); phaseLabel.textContent="Ready"; orb.style.transform="scale(1)"; } $("#breath-start").onclick=()=>{ stopBreath(); runBreath(); }; $("#breath-stop").onclick=()=>{ stopBreath(); }; document.addEventListener("keydown", function space(e){ if($("#ritual").style.display!=="none" && e.code==="Space"){ e.preventDefault(); if(running){ paused=!paused; if(!paused) sequence(); } } }); $("#recite-mark").onclick=()=>{ recite++; vibrate(10); update(); }; const c=$("#micro-canvas"), ctx=c.getContext("2d"); ctx.strokeStyle="#ff66a3"; ctx.lineWidth=6; ctx.lineCap="round"; let drawing=false; c.addEventListener("mousedown", e=>{ drawing=true; draw(e); }); c.addEventListener("mousemove", draw); window.addEventListener("mouseup", ()=>{ drawing=false; ctx.beginPath(); }); c.addEventListener("touchstart", e=>{ drawing=true; draw(e); }, {passive:true}); c.addEventListener("touchmove", draw, {passive:true}); window.addEventListener("touchend", ()=>{ drawing=false; ctx.beginPath(); }); function draw(e){ if(!drawing) return; const r=c.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; ctx.lineTo(x,y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x,y); strokes++; update(); } $("#ritual-complete").onclick=()=>{ if($("#ritual-complete").disabled) return; localStorage.setItem("areaUnlocked_"+areaId,"1"); speak("The chamber opens."); openArea(areaId); window.scrollTo({top:0, behavior:"smooth"}); }; }
function renderAreaMemories(){ const key="memUser_"+currentArea.id; const list=JSON.parse(localStorage.getItem(key)||"[]"); $("#am-list").innerHTML=list.map(x=>`<div class="card"><strong>${x.title}</strong><div style="opacity:.9; margin-top:6px">${x.content||""}</div></div>`).join(""); $("#am-save").onclick=()=>{ const title=$("#am-title").value.trim(); const content=$("#am-content").value.trim(); if(!title){ speak("Title is required."); return; } const arr=JSON.parse(localStorage.getItem(key)||"[]"); arr.push({id:"u-"+Date.now(), title, content}); localStorage.setItem(key, JSON.stringify(arr)); $("#am-title").value=""; $("#am-content").value=""; renderAreaMemories(); }; }
function getGalleryKeys(areaId=null){ if(areaId) return { user:`gallery_${areaId}`, order:`galleryOrder_${areaId}` }; return { user:"galleryUser", order:"galleryOrder" }; }
function getGallery(areaId=null){ const k=getGalleryKeys(areaId).user; try{ return JSON.parse(localStorage.getItem(k)||"[]"); }catch(e){ return []; } }
function saveGallery(arr, areaId=null){ localStorage.setItem(getGalleryKeys(areaId).user, JSON.stringify(arr)); }
function getOrder(areaId=null){ const k=getGalleryKeys(areaId).order; try{ return JSON.parse(localStorage.getItem(k)||"[]"); }catch(e){ return []; } }
function saveOrder(order, areaId=null){ localStorage.setItem(getGalleryKeys(areaId).order, JSON.stringify(order)); }
function renderGalleryGrid(rootEl, areaId=null){ const items=getGallery(areaId); const order=getOrder(areaId); if(order.length===0 && items.length>0){ saveOrder(items.map(i=>i.id), areaId); } items.sort((a,b)=> order.indexOf(a.id)-order.indexOf(b.id)); rootEl.innerHTML = items.map(x=>{ const hidden=x.visible===false; return `<div class="gallery-item ${hidden?'hidden':''} draggable" draggable="true" data-id="${x.id}">${hidden?`<div class="placeholder">·õù <button class="showbtn btn secondary" data-id="${x.id}">Show</button></div>`:`<img src="${x.src}" alt="${x.label||'image'}" />`}<div class="overlay"><span class="tag">${x.label||'image'}</span>${hidden?'':'<span class="tag">Click to Hide</span>'}</div></div>`; }).join(""); rootEl.querySelectorAll(".gallery-item").forEach(el=>{ const id=el.dataset.id; if(el.classList.contains("hidden")){ el.querySelector(".showbtn").onclick=()=>{ const arr=getGallery(areaId); const ix=arr.findIndex(i=>i.id===id); if(ix>=0){ arr[ix].visible=true; saveGallery(arr, areaId); renderGalleryGrid(rootEl, areaId); } }; } else { el.onclick=()=>{ const arr=getGallery(areaId); const ix=arr.findIndex(i=>i.id===id); if(ix>=0){ arr[ix].visible=false; saveGallery(arr, areaId); renderGalleryGrid(rootEl, areaId); } }; } }); let dragId=null; rootEl.querySelectorAll(".draggable").forEach(el=>{ el.addEventListener("dragstart", e=>{ dragId=el.dataset.id; e.dataTransfer.setData("text/plain", dragId); }); el.addEventListener("dragover", e=>{ e.preventDefault(); el.classList.add("drop-target"); }); el.addEventListener("dragleave", ()=> el.classList.remove("drop-target")); el.addEventListener("drop", e=>{ e.preventDefault(); el.classList.remove("drop-target"); const targetId=el.dataset.id; if(!dragId || dragId===targetId) return; const order=getOrder(areaId).filter(Boolean); const from=order.indexOf(dragId), to=order.indexOf(targetId); if(from<0 || to<0) return; order.splice(to,0, order.splice(from,1)[0]); saveOrder(order, areaId); renderGalleryGrid(rootEl, areaId); }); }); }
function setupUpload(buttonEl, inputEl, rootEl, areaId=null){ buttonEl.onclick=()=> inputEl.click(); inputEl.addEventListener("change",(e)=>{ const files=[...e.target.files]; if(!files.length) return; const arr=getGallery(areaId); const order=getOrder(areaId); let pending=files.length; files.forEach((f, idx)=>{ const reader=new FileReader(); reader.onload=()=>{ const id=(areaId?areaId:"u")+"-"+Date.now()+"-"+idx; arr.push({id, src:reader.result, label:f.name, visible:true, kind:"upload", addedAt:new Date().toISOString()}); order.push(id); if(--pending===0){ saveGallery(arr, areaId); saveOrder(order, areaId); renderGalleryGrid(rootEl, areaId); } }; reader.readAsDataURL(f); }); e.target.value=""; }); }
function renderGlobalGallery(){ const root=$("#gallery-user"); renderGalleryGrid(root, null); setupUpload($("#gallery-upload-btn"), $("#gallery-upload"), root, null); }
function renderAreaGallery(){ const root=$("#area-gallery-grid"); renderGalleryGrid(root, currentArea.id); setupUpload($("#area-upload-btn"), $("#area-upload"), root, currentArea.id); }
function loadSettingsUI(){ $("#set-mute").checked=!!settings.mute; $("#set-reduce").checked=!!settings.reduceMotion; $("#set-theme").value=settings.theme||"dominant"; $("#set-save").onclick=()=>{ settings.mute=$("#set-mute").checked; settings.reduceMotion=$("#set-reduce").checked; settings.theme=$("#set-theme").value; localStorage.setItem("settings", JSON.stringify(settings)); speak("Settings saved."); }; $("#reset-rituals").onclick=()=>{ AREA_INDEX.forEach(a=>{ localStorage.removeItem("areaUnlocked_"+a.id); }); speak("All areas relocked."); renderAreas(); $("#area-view").classList.remove("active"); $("#tab-sanctum").classList.add("active"); }; }
window.addEventListener("DOMContentLoaded", async ()=>{ await loadAreas(); if(localStorage.getItem("rememberUnlocked")==="1"){ $("#shell").style.display="block"; $("#topbar").setAttribute("aria-hidden","false"); await setUnlockedBackground(); glyphTimer = settings.reduceMotion ? null : spawnGlyphs(); renderAreas(); renderGlobalGallery(); loadSettingsUI(); } else { showLock(); loadSettingsUI(); } $$(".navbtn").forEach(b=> b.onclick=()=>{ $$(".navbtn").forEach(x=>x.classList.remove("active")); b.classList.add("active"); $$(".tab").forEach(t=>t.classList.remove("active")); const id="tab-"+b.dataset.tab; $("#"+id).classList.add("active"); if(id==="tab-gallery"){ renderGlobalGallery(); } if(id==="tab-sanctum"){ renderAreas(); } window.scrollTo({top:0, behavior:"smooth"}); }); });
</script>
</body>
</html>
